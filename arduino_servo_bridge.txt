/*
Arduino Servo Bridge for PCA9685 Testing
Receives servo commands via USB Serial and controls PCA9685
*/

#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();

// Servo parameters
#define SERVO_MIN 150   // Min pulse length count (out of 4096)
#define SERVO_MAX 600   // Max pulse length count (out of 4096)

void setup() {
  Serial.begin(115200);
  Serial.println("Arduino PCA9685 Servo Bridge Ready");
  
  pwm.begin();
  pwm.setPWMFreq(50);  // 50Hz for servos
  
  delay(10);
}

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\n');
    command.trim();
    
    // Parse command: "SERVO,channel,angle"
    // Example: "SERVO,0,90" sets channel 0 to 90 degrees
    
    if (command.startsWith("SERVO,")) {
      int firstComma = command.indexOf(',');
      int secondComma = command.indexOf(',', firstComma + 1);
      
      if (firstComma > 0 && secondComma > firstComma) {
        int channel = command.substring(firstComma + 1, secondComma).toInt();
        float angle = command.substring(secondComma + 1).toFloat();
        
        // Convert angle to pulse width
        int pulseWidth = map(angle, -90, 90, SERVO_MIN, SERVO_MAX);
        pulseWidth = constrain(pulseWidth, SERVO_MIN, SERVO_MAX);
        
        pwm.setPWM(channel, 0, pulseWidth);
        
        Serial.print("OK: Channel ");
        Serial.print(channel);
        Serial.print(" set to ");
        Serial.print(angle);
        Serial.println(" degrees");
      } else {
        Serial.println("ERROR: Invalid command format");
      }
    } else if (command == "CENTER") {
      // Center both servos
      int centerPulse = (SERVO_MIN + SERVO_MAX) / 2;
      pwm.setPWM(0, 0, centerPulse);
      pwm.setPWM(1, 0, centerPulse);
      Serial.println("OK: Servos centered");
    } else if (command == "OFF") {
      // Turn off all servos
      pwm.setPWM(0, 0, 0);
      pwm.setPWM(1, 0, 0);
      Serial.println("OK: Servos disabled");
    } else {
      Serial.println("ERROR: Unknown command");
      Serial.println("Commands: SERVO,channel,angle | CENTER | OFF");
    }
  }
}
